<!DOCTYPE html>
<html>
<head>
	<meta charset="utf-8">
	<title>Icon Array -example 3</title>

	<script src="d3.v3.js" charset="utf-8"></script>
	<script type="text/javascript" src="icon-array.js"></script>
	
	<style>

	body{
		font-family: sans-serif;
	}

	.key-label{
		font-size: small;
	}

	td{
		vertical-align:middle;
	}

	.key{
		display:inline-block;
	}

	.content{
		display:inline-block;
		float:left;
	}
	</style>

</head>
<body>
<h3>400 pieces of fruit!</h3>
	<div class="key"></div>
	<div class="content"></div>
	<p></p>
</body>
<script>
	var defaultIconSize = 100; //assume the icons are 100 pixel squares
	var iconFile = 'icons/fruit-emoji.svg';


	var fruitData = [
		{
			fruit : 'banana',
			value : 20
		},
		{
			fruit : 'strawberry',
			value : 32
		},
		{
			fruit : 'lemon',
			value : 44
		},
		{
			fruit : 'orange',
			value : 34
		},
		{
			fruit : 'mellon',
			value : 34
		},
		{
			fruit : 'watermellon',
			value : 93
		},
		{
			fruit : 'pineapple',
			value : 15
		},
		{
			fruit : 'mellon',
			value : 34
		},
		{
			fruit : 'pear',
			value : 60
		},
		{
			fruit : 'apple',
			value : 34
		},
	];

	// expand the data into an array of individual items
	function expand(array, countAccessor, valueAccessor){ 
		return array.reduce(function(value, d){
			var l = new Array( countAccessor(d) );
			for (var i =0; i< l.length; i++){
				value.push( valueAccessor(d) );
			}
			return value;
		}, []);
	}

	var dataArray = expand( fruitData, 
		function countAccessor (d) { return Number(d.value); },
		function valueAccessor (d) { return d; } );

	var myArrayLayout = d3.layout.iconArray();

	dataArray = myArrayLayout( dataArray ); 

	var width = 900, height = 400,
		margin = {top:0, left:0, bottom:0, right:0},
		plotWidth = width - (margin.left + margin.right),
		plotHeight = height - (margin.top + margin.bottom);

	var arrayScale = d3.scale.linear()
		.domain([ 0, myArrayLayout.maxDimensions( dataArray.length ).max ])
		.range([ 0, plotWidth ]);

	var scaleFactor = arrayScale(0.9) / defaultIconSize;  //0.9 so we get a little bit of extra space around each icon graphic i.e. the icon takes up 90% of the available space in the mosr constrained dimension
	
	//add the icon array...
	d3.select('.content')
		.append('svg').attr({ 
			width:width+(margin.left+margin.right), 
			height:height+(margin.top+margin.bottom) })
		.append('g').attr('transform','translate('+margin.left+','+margin.top+')')
			.selectAll('circle')
		.data( dataArray )
			.enter()
		.append('g')
			.attr({
				transform:function(d){
					var xPos = arrayScale(d.x),
						yPos = arrayScale(d.y);
					return 'translate(' + xPos +Â ',' + yPos + ')';
				}
			})
		.append('use')
			.attr('xlink:href',function(d){
				console.log(d.data);
				return iconFile + '#' + d.data.fruit;
			})
			.attr('transform','scale(' + scaleFactor + ')');


//add a key
	d3.select('.key')
		.insert('table').attr('class','key')
		.selectAll('div.key-element')
			.data(fruitData)
		.enter()
			.append('tr')
				.attr('class','key-element')
				.call(function(row){
					row.append('td')
						.attr('class','key-swatch')
						.append('svg')
							.attr({
								width:defaultIconSize*scaleFactor,
								height:defaultIconSize*scaleFactor
							})
						.append('use')
							.attr('xlink:href',function(d){
								return iconFile + '#' + d.fruit;
							})
							.attr('transform','scale(' + scaleFactor + ')');

					row.append('td')
						.attr('class','key-label')
						.text(function(d){
							return d.fruit + ' (' + d.value + ')';
						});
				});


</script>
</html>
