<html>
<head>
	<title>example 4</title>

	<script src="d3.v3.js" charset="utf-8"></script>
	<script type="text/javascript" src="icon-array.js"></script>
	<style>

	body{
		font-family: sans-serif;
	}


	.content{

	}

	.source{
		font-style: italic;
		color: #888;
	}

	.source a, 
	.source a:visited{
		color: #888;
	}

	.city-link{
		margin-right: 10px;
		text-decoration: none;
	}

	.city-link:hover{
		background-color: #00F;
		color: #FFF;
	}

	.chart-title{
		font-size: 30;
		font-weight: 100;
	}

	h1{
		padding: 0;
		margin-top: 20;
		margin-bottom: 10;
	}
	h2{
		padding: 0;
		margin-top: 10;
		margin-bottom: 20;
	}
	.key-element{
		margin-right: 30;
		font-weight: 100;
	}

	.tick-label{
		font-weight: 100;
		fill: #888;
		font-size: 12;
	}
	.tick-line{
		stroke: #ddd;
		stroke-width:1;
		shape-rendering:crispEdges;
	}

	</style>
</head>

<body>
<h1>Modal transport share</h1>
	<div class="key"></div>
	<div class="nav"><b>Choose a city:</b> </div>
	<div class="content"></div>
	<div class="source">source: <a href="https://en.wikipedia.org/wiki/Modal_share">Wikipedia</a> &mdash; 25 September 2015</div>
	<p></p>
</body>
<script type="text/javascript">
var iconFile = 'icons/transport-emoji.svg'


d3.tsv('data/modal-share-data.tsv', function(data){
	var categories = ['private motor vehicle','public transport','walking','cycling'];
	d3.select('.nav').selectAll('a')
		.data(data)
			.enter()
		.append('a')
			.attr({
				'href':function(d){ return '#'+toID(d.City); },
				'data-city':function(d){ return d.City; },
				'class':'city-link'
			})
			.on('click', function(d){ drawChart(d,categories); return false; })
			.text(function(d){ return d.City + ' '; });

	d3.select('.key')
		.append('h2')
			.selectAll('span')
		.data(categories)
			.enter()
		.append('span')
			.attr('class','key-element')
			.text(function(d){
				return d;
			});
});

function drawChart(data, categories){
	
	var width = 600, 
		height = 700, 
		margin = {
			top:100, 
			left:20, 
			bottom:20, 
			right:20
		};
	var gap = 0.5;
	var barSpacing = 10;
	var barHeight = 30;
	var iconBar = d3.layout.iconArray()
		.blockWidth(5) //have a nice gap in the bar every 25 icons for ease of counting
		.blockHeight(5)
		.blockGap(gap)
		.verticalFirst(true);

	var barDimensions = iconBar.maxDimensions(100);

	var arrayScale = d3.scale.linear()
		.range( [0, width-(margin.left+margin.right)] )
		.domain( [0, barDimensions.x] );

	var barScale = d3.scale.linear()
		.range( [0, (arrayScale(barDimensions.y) + barSpacing)*categories.length] )
		.domain( [0, categories.length ] );

	var iconScale = arrayScale(0.8)/100;

	var axis = arrayAxis()
		.arrayScale(arrayScale)
		.layout(iconBar)
		.tickSize([ -10, barScale.range()[1] ])
		.ticks([25, 50, 75, 100]);

	var svg = d3.select('.content').selectAll('svg')
		.data([data], function(d){d.City})
			.enter()
		.append('svg')
			.attr({
				'class': 'chart',
				'width': width,
				'height': barScale(categories.length)+margin.top+margin.bottom
			})
		.append('g')
			.call(function(parent){
				parent.attr('transform','translate('+margin.left+','+margin.top+')');
				parent.append('text').attr({
					'class':'chart-title',
					dy:-barSpacing*4
				});
			});

	

	svg.selectAll('g.bar')
		.data(categories)
			.enter()
		.append('g')
			.attr({
				'transform':function(d,i){
					return 'translate(' + 0 + ',' + barScale(i) + ')';
				},
				'class':'bar'
			})
		.each(function(d,i){
			if(i==0){
				d3.select(this)
					.call(axis);
			}
		});
		

	d3.selectAll('g.bar')
		.call(function(parent){
			var join = parent.selectAll('g.icon')
				.data(function(d){
					var expanded = d3.range(0,data[d],1)
									.map(function(){ return d; });
					return iconBar(expanded); 
				},function(e,i){ return 'd'+i; })
			
			join.enter()
				.append('g')
					.attr({
						'class':'icon',
						'transform':function(d){
							return 'translate(' + arrayScale(d.x) + ',' + arrayScale(d.y) + ')';
						}
					})
				.append('use')
					.attr({
						'xlink:href':function(d){
							return iconFile + '#' + toID(d.data);
						},
						'transform':'scale('+iconScale+')'
					});

			join.exit().remove();
		})

	d3.select('.chart-title').html(data.City+' &mdash; '+data.Country);
}

function toID(s){
	return s.replace(/\W/g,'-').toLowerCase();
}
</script>
<script type="text/javascript">
	//icon array axis

	function arrayAxis(){
		var layout,
			arrayScale,
			ticks,
			tickSize = [-10,10];

		function axis(g){
			console.log(g, this);
			g.selectAll('tick')
				.data(ticks)
					.enter()
				.append('g')
					.attr({
						'class':'tick',
						'transform':function(d){
							//if the tick is just before a gap, the subtract that gap
							console.log('a,',layout.blockArea())
							if(d%layout.blockArea() == 0){
								var xPos = arrayScale( layout.position(d).x - layout.blockGap());
							}else{
								xPos = arrayScale( layout.position(d).x );
							}
							return 'translate(' + Math.round(xPos) + ',0)';
						}
					})
				.call(function(parent){
					parent.append('text')
						.attr({
							'text-anchor':'end',
							'class':'tick-label',
							dx:-3
						})
						.text(function(d){
							return d;
						});

					parent.append('line')
						.attr({
							'class':'tick-line',
							x1:0,
							y1:tickSize[0],
							x2:0,
							y2:tickSize[1]
						})
				})
		}

		axis.tickSize = function(e){
			if(!e) return tickSize;
			tickSize = e;
			return axis;
		}

		axis.arrayScale = function(s){
			if(!s) return arrayScale;
			arrayScale = s;
			return axis;
		}

		axis.layout = function(l){
			if(!l) return  layout;
			layout = l;
			return axis;
		}

		axis.ticks = function(t){
			if(!t) return  ticks;
			ticks = t;
			return axis;
		}
		return axis;
	}
</script>
</html>