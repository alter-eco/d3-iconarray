<!DOCTYPE html>
<html>
<head>
	<meta charset="utf-8">
	<title>Icon Array</title>

	<script src="d3.v3.js" charset="utf-8">
	</script>
	
	<script type="text/javascript" src="icon-array.js">
	</script>
	
	<style>

	body{
		font-family: sans-serif;
	}

	.key-label{
		font-size: small;
	}

	td{
		vertical-align:middle;
	}

	.key{
		display:inline-block;
	}

	.content{
		display:inline-block;
		float:left;
	}
	</style>

	<title>D3 Icon Array</title>
</head>
<body>
	<h3>Icon array showing various outcomes associated with Group B Strep (GBS) among pregnant women</h3>
	
	<div class="key"></div>
	<div class="content"></div>
	<p>after <a href="http://blogs.scientificamerican.com/sa-visual/inadequate-data-visualization-leaves-patients-undereducated/">Amanda Monta√±ez &mdash; Inadequate Data Visualization Leaves Patients Undereducated</a></p>
</body>
<script>
	console.log('D3 Icon Array (D3 v' + d3.version + ')');

	data = [
		{
			label:'Women who test negative for GBS',
			color:'#7EC2EA',
			count:402
		},
		{
			label:'Women who test positive but do not pass the bacteria to their babies',
			color:'#0093A2',
			count:49
		},
		{
			label:'Women who pass the bacteria to their babies without resulting in illness',
			color:'#ED7B9D',
			count:48
		},
		{
			label:'Women who whose babies contract early onset GBS disease',
			color:'#805882',
			count:1
		},
	];

// expand the data into an array of individual items
	function expand(array, countAccessor, valueAccessor){ 
		return array.reduce(function(value, d){
			var l = new Array( countAccessor(d) );
			for (var i =0; i< l.length; i++){
				value.push( valueAccessor(d) );
			}
			return value;
		}, []);
	}

	var dataArray = expand( data, 
		function countAccessor (d) { return Number(d.count); },
		function valueAccessor (d) { return d; } );

// create the array layout
	var myArrayLayout = d3.layout.iconArray()
		.blockWidth(25)
		.blockHeight(40)
		.blockGap(1);

	dataArray = myArrayLayout( dataArray );

//a scale etc.
var width = 600, height = 600,
	margin = {top:15, left:10, bottom:0, right:0},
	plotWidth = width - (margin.left + margin.right),
	plotHeight = height - (margin.top + margin.bottom);

var arrayScale = d3.scale.linear()
	.domain([0, myArrayLayout.maxDimensions( dataArray.length ).max ])
	.range([0, Math.min(plotHeight, plotWidth)]);

//add the icon array...
d3.select('.content')
	.append('svg').attr({ 
		width:width+(margin.left+margin.right), 
		height:height+(margin.top+margin.bottom) })
	.append('g').attr('transform','translate('+margin.left+','+margin.top+')')
		.selectAll('circle')
	.data(dataArray)
		.enter()
	.append('circle')
		.attr({
			cx:function(d){ return arrayScale( d.x ); },
			cy:function(d){ return arrayScale( d.y ); },
			fill:function(d){ return d.data.color; },
			r:arrayScale(0.3)
		});

//add a key
d3.select('.key')
	.insert('table').attr('class','key')
	.selectAll('div.key-element')
		.data(data)
	.enter()
		.append('tr')
			.attr('class','key-element')
			.call(function(row){
				row.append('td')
					.attr('class','key-swatch')
					.append('svg')
					.attr({
						width:arrayScale(1),
						height:arrayScale(1)
					})
					.append('circle')
					.attr({
						cx:arrayScale(0.5),
						cy:arrayScale(0.5),
						r:arrayScale(0.3),
						fill:function(d){ return d.color; }
					});

				row.append('td')
					.attr('class','key-label')
					.text(function(d){
						return d.label;
					});
			});

	d3.select(self.frameElement)
		.style("height", d3.select('.content').node().getBoundingClientRect().height + "px");
</script>
</html>