<!DOCTYPE html>
<html>
<head>
	<meta charset="utf-8">
	<title>Icon Array -example 2</title>

	<script src="d3.v3.js" charset="utf-8"></script>
	<script type="text/javascript" src="icon-array.js"></script>
	
	<style>

	body{
		font-family: sans-serif;
	}

	.key-label{
		font-size: small;
	}

	td{
		vertical-align:middle;
	}

	.key{
		display:inline-block;
	}

	.content{
		display:inline-block;
		float:left;
	}
	</style>

</head>
<body>
<h3>How people travel in London</h3>
	<div class="key"></div>
	<div class="content"></div>
	<p>Modal transport share. London 2011. <a href="https://en.wikipedia.org/wiki/Modal_share">Source</a></p>
</body>
<script>
	var defaultIconSize = 100; //assume the icons are 100 pixel squares
	var iconFile = {
		'male':'icons/male.svg',
		'female':'icons/female.svg',
		'walking':'icons/pedestrian.svg',
		'cycling':'icons/bicycle.svg',
		'public transport':'icons/bus.svg',
		'private motor vehicle':'icons/car.svg'
	};


	var modalShareData = [{
			mode : 'walking',
			pct : 20
		},
		{
			mode : 'cycling',
			pct : 2
		},
		{
			mode : 'public transport',
			pct : 44
		},
		{
			mode : 'private motor vehicle',
			pct : 34
		},
	];

	var data = [
		{
			mode: 'male',
			pct: 45
		},
		{
			mode: 'female',
			pct: 55
		}
	];

	// expand the data into an array of individual items
	function expand(array, countAccessor, valueAccessor){ 
		return array.reduce(function(value, d){
			var l = new Array( countAccessor(d) );
			for (var i =0; i< l.length; i++){
				value.push( valueAccessor(d) );
			}
			return value;
		}, []);
	}

	var dataArray = expand( modalShareData, 
		function countAccessor (d) { return Number(d.pct); },
		function valueAccessor (d) { return d; } );

	var myArrayLayout = d3.layout.iconArray();

	dataArray = myArrayLayout( dataArray ); 

	var width = 600, height = 600,
		margin = {top:20, left:20, bottom:20, right:20},
		plotWidth = width - (margin.left + margin.right),
		plotHeight = height - (margin.top + margin.bottom);

	var arrayScale = d3.scale.linear()
		.domain([ 0, myArrayLayout.maxDimensions( dataArray.length ).max ])
		.range([ 0, Math.min( plotHeight, plotWidth ) ]);

	var scaleFactor = arrayScale(0.9) / defaultIconSize;  //0.9 so we get a little bit of extra space around each icon graphic i.e. the icon takes up 90% of the available space in the mosr constrained dimension
	
	//add the icon array...
	d3.select('.content')
		.append('svg').attr({ 
			width:width+(margin.left+margin.right), 
			height:height+(margin.top+margin.bottom) })
		.append('g').attr('transform','translate('+margin.left+','+margin.top+')')
			.selectAll('circle')
		.data( dataArray )
			.enter()
		.append('g')
			.attr({
				transform:function(d){
					var xPos = arrayScale(d.x),
						yPos = arrayScale(d.y);
					return 'translate(' + xPos +Â ',' + yPos + ')';
				}
			})
		.append('use')
			.attr('xlink:href',function(d){
				console.log(d.data.mode);
				return iconFile[d.data.mode]+'#icon';
			})
			.attr('transform','scale(' + scaleFactor + ')');


//add a key
	d3.select('.key')
		.insert('table').attr('class','key')
		.selectAll('div.key-element')
			.data(modalShareData)
		.enter()
			.append('tr')
				.attr('class','key-element')
				.call(function(row){
					row.append('td')
						.attr('class','key-swatch')
						.append('svg')
							.attr({
								width:defaultIconSize*scaleFactor,
								height:defaultIconSize*scaleFactor
							})
						.append('use')
							.attr('xlink:href',function(d){
								return iconFile[d.mode]+'#icon';
							})
							.attr('transform','scale(' + scaleFactor + ')');

					row.append('td')
						.attr('class','key-label')
						.text(function(d){
							return d.mode + ' (' + d.pct + '%)';
						});
				});


</script>
</html>
